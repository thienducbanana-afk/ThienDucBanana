local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local workspace = game:GetService("Workspace")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local screenGui = Instance.new("ScreenGui", game.CoreGui)
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 160, 0, 110)
mainFrame.Position = UDim2.new(0.5, -80, 0.5, -55)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
mainFrame.BackgroundTransparency = 0.3
mainFrame.BorderSizePixel = 0
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

local titleBar = Instance.new("Frame", mainFrame)
titleBar.Size = UDim2.new(1, 0, 0, 35)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
titleBar.BackgroundTransparency = 0.2
local titleText = Instance.new("TextLabel", titleBar)
titleText.Size = UDim2.new(1, 0, 1, 0)
titleText.Text = "ThienDucBrainrot V1"
titleText.TextColor3 = Color3.new(1, 1, 1)
titleText.Font = Enum.Font.GothamBold
titleText.TextSize = 14
titleText.BackgroundTransparency = 1

local godmodeBtn = Instance.new("TextButton", mainFrame)
godmodeBtn.Size = UDim2.new(0.85, 0, 0, 45)
godmodeBtn.Position = UDim2.new(0.075, 0, 0.45, 0)
godmodeBtn.Text = "Godmode: OFF"
godmodeBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
godmodeBtn.TextColor3 = Color3.new(1, 1, 1)
godmodeBtn.Font = Enum.Font.GothamSemibold
godmodeBtn.TextSize = 14
Instance.new("UICorner", godmodeBtn).CornerRadius = UDim.new(0, 8)

local dragging, dragStart, startPos, dragInput
titleBar.InputBegan:Connect(function(input)
    if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
        dragging = true dragStart = input.Position startPos = mainFrame.Position dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input) if input == dragInput then dragging = false end end)

local isGodmode, ghostClone, connection, noclipConn, deathConn = false, nil, nil, nil, nil
local originalDistances = {}

local function cleanup()
    isGodmode = false
    godmodeBtn.Text = "Godmode: OFF"
    godmodeBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    
    if connection then connection:Disconnect() connection = nil end
    if noclipConn then noclipConn:Disconnect() noclipConn = nil end
    if deathConn then deathConn:Disconnect() deathConn = nil end
    
    -- Restore original ProximityPrompt distances
    for prompt, dist in pairs(originalDistances) do
        if prompt and prompt.Parent then
            prompt.MaxActivationDistance = dist
        end
    end
    originalDistances = {}

    local char = player.Character
    if char then
        for _, v in pairs(char:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = true end
        end
        local root = char:FindFirstChild("HumanoidRootPart")
        if root and ghostClone then root.CFrame = ghostClone.HumanoidRootPart.CFrame end
        if char:FindFirstChild("Humanoid") then 
            char.Humanoid.PlatformStand = false 
            camera.CameraSubject = char.Humanoid 
        end
    end
    if ghostClone then ghostClone:Destroy() ghostClone = nil end
end

godmodeBtn.MouseButton1Click:Connect(function()
    isGodmode = not isGodmode
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    
    if isGodmode then
        godmodeBtn.Text = "Godmode: ON"
        godmodeBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        
        char.Archivable = true
        ghostClone = char:Clone()
        ghostClone.Name = "GhostDecoy"
        ghostClone.Parent = workspace
        char.Archivable = false
        
        for _, v in pairs(ghostClone:GetDescendants()) do
            if v:IsA("BasePart") then
                v.Transparency = (v.Name:lower():find("root") or v.Name:lower():find("collision")) and 0.5 or 0
                v.CanCollide = true
            end
        end

        if char:FindFirstChild("Animate") then char.Animate:Clone().Parent = ghostClone end
        char.Humanoid.PlatformStand = true
        camera.CameraSubject = ghostClone.Humanoid
        
        noclipConn = RunService.Stepped:Connect(function()
            if char then 
                for _, v in pairs(char:GetDescendants()) do 
                    if v:IsA("BasePart") then v.CanCollide = false end 
                end 
            end
        end)

        connection = RunService.Heartbeat:Connect(function()
            if ghostClone and char:FindFirstChild("HumanoidRootPart") then
                local moveDir = char.Humanoid.MoveDirection
                ghostClone.Humanoid:Move(moveDir, false)
                ghostClone.Humanoid.Jump = char.Humanoid.Jump
                
                if moveDir.Magnitude > 0 then
                    local targetRot = CFrame.lookAt(ghostClone.HumanoidRootPart.Position, ghostClone.HumanoidRootPart.Position + moveDir)
                    ghostClone.HumanoidRootPart.CFrame = ghostClone.HumanoidRootPart.CFrame:Lerp(targetRot, 0.25)
                end
                
                -- Dynamic Expander (Only while Godmode is ON)
                for _, p in pairs(workspace:GetDescendants()) do
                    if p:IsA("ProximityPrompt") then
                        if not originalDistances[p] then
                            originalDistances[p] = p.MaxActivationDistance
                        end
                        p.MaxActivationDistance = 16 -- Perfect for 15 stud depth
                        p.RequiresLineOfSight = false
                    end
                end
                
                char.HumanoidRootPart.CFrame = ghostClone.HumanoidRootPart.CFrame * CFrame.new(0, -15, 0)
                char.HumanoidRootPart.Velocity = Vector3.zero
            else cleanup() end
        end)
        deathConn = char.Humanoid.Died:Connect(cleanup)
    else cleanup() end
end)